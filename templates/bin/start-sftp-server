#!/bin/bash
# start-sftp-server

set -e

if [ -z "$ADMIN_USER" ] || [ -z $PASSWORD ]; then
  echo '$ADMIN_USER and $PASSWORD must be set. Exiting!'
  exit 1
fi

# Generate SSH host keys
if [ ! -f /etc/ssh/keys/ssh_host_ecdsa_key ]; then
  ssh-keygen -f /etc/ssh/keys/ssh_host_ecdsa_key -N '' -t ecdsa
fi

if [ ! -f /etc/ssh/keys/ssh_host_rsa_key ]; then
  ssh-keygen -f /etc/ssh/keys/ssh_host_rsa_key -N '' -t rsa
fi

if [ ! -f /etc/ssh/keys/ssh_host_dsa_key ]; then
  ssh-keygen -f /etc/ssh/keys/ssh_host_dsa_key -N '' -t dsa
fi

restore-sftp-users
add-privileged-user $ADMIN_USER $PASSWORD

rsyslogd
/usr/sbin/sshd

# Wait for /var/log/auth.log to exist, then tail it
while [ ! -f /var/log/auth.log ] ; do sleep 0.1; done
tail -f /var/log/auth.log
